<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Twitch Sound List</title>

<!-- ================== STYLES ================== -->
<style>
/* ===== Body & Gradient Background ===== */
body {
    font-family: Arial, sans-serif;
    padding: 20px;
    background: linear-gradient(270deg in oklab, #4d480a, #120b49, #410d47, #043306);
    background-size: 400% 400%;
    animation: gradientBG 60s linear infinite alternate;
    transition: background 0.5s ease, color 0.5s ease;
    color: transparent;
}

@keyframes gradientBG {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}

/* ===== Light Mode Body ===== */
body.lightmode {
    background: linear-gradient(270deg in oklab, #e2d522, #3b27f0, #cc26e2, #18d821);
    color: transparent;
}

/* ===== Container ===== */
.container {
    max-width: 900px;
    margin: 0 auto;
}
.container > h1 {
    color: #fff;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
    margin-bottom: 15px;
}
body.lightmode .container > h1 {
    color: #000;
    text-shadow: 1px 1px 2px rgba(255,255,255,0.5);
}

/* ===== Sound Item Cards (Frosted Glass) ===== */
.sound-item {
    display: flex;
    align-items: center;
    margin: 10px 0;
    padding: 10px;
    border: 2px solid #000;
    border-radius: 12px;
    background: rgba(0,0,0,0.3);
    backdrop-filter: blur(6px);
    transition: background 0.5s ease, border-color 0.5s ease, color 0.5s ease;
}
.sound-item img {
    width: 50px;
    height: 50px;
    object-fit: contain;
    margin-right: 15px;
    border-radius: 5px;
    background: transparent;
    cursor: pointer;
    transition: transform 0.2s ease;
}
.sound-item img:hover { transform: scale(1.2); }

.sound-item div {
    color: #fff;
    text-shadow: 1px 1px 3px rgba(0,0,0,0.7);
}

/* ===== Links ===== */
.sound-item a {
    color: #fff;
    text-decoration: underline;
}
body.lightmode .sound-item a { color: #000; }

/* ===== Light Mode Card Overrides ===== */
body.lightmode .sound-item {
    border: 5px solid #000;
    background: rgba(255,255,255,0.6);
}
body.lightmode .sound-item div {
    color: #000;
    text-shadow: 1px 1px 2px rgba(255,255,255,0.5);
}

/* ===== Contact Button Card ===== */
.contact-card {
    display: inline-block;
    padding: 15px;
    border-radius: 16px;
    border: 2px solid #000;
    background: rgba(0,0,0,0.3);
    backdrop-filter: blur(6px);
    transition: all 0.3s ease;
}
.contact-card:hover {
    box-shadow: 0 0 20px rgba(255,255,255,0.8);
    transform: scale(1.05);
}
body.lightmode .contact-card {
    background: rgba(255,255,255,0.6);
    border: 2px solid #000;
}
body.lightmode .contact-card:hover {
    box-shadow: 0 0 20px rgba(0,0,0,0.7);
}

/* ===== Toggle Switch (Dark/Light Mode) ===== */
.switch {
    font-size: 17px;
    position: relative;
    display: inline-block;
    width: 3.5em;
    height: 2em;
}
.switch input { opacity: 0; width: 0; height: 0; }

.slider {
    --background: #28096b;
    position: absolute;
    cursor: pointer;
    top: 0; left: 0; right: 0; bottom: 0;
    background-color: var(--background);
    transition: .5s;
    border-radius: 30px;
}
.slider:before {
    position: absolute;
    content: "";
    height: 1.4em;
    width: 1.4em;
    border-radius: 50%;
    left: 10%;
    bottom: 15%;
    box-shadow: inset 8px -4px 0px 0px #fff000;
    background: var(--background);
    transition: .5s;
}
input:checked + .slider {
    background-color: #522ba7;
}
input:checked + .slider:before {
    transform: translateX(100%);
    box-shadow: inset 15px -4px 0px 15px #fff000;
}

/* ===== Loading Spinner ===== */
.spinner, .spinner-overlay { display: none; }
.spinner { 
    width: 20px; height: 20px;
    border: 3px solid rgba(255,255,255,0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin-left: auto;
}
body.lightmode .spinner {
    border: 3px solid rgba(0,0,0,0.3);
    border-top-color: black;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* ===== Custom Loader ===== */
    /* From Uiverse.io by aryamitra06 */ 
.loader {
  display: flex;
  justify-content: center;  /* center bars inside the loader div */
  align-items: center;
  height: 50px;             /* optional: adjusts vertical space inside card */
}
.bar {
  display: inline-block;
  width: 3px;
  height: 20px;
  background-color: rgba(255, 255, 255, 0.5);
  border-radius: 10px;
  animation: scale-up4 1s linear infinite;
}
.bar:nth-child(2) {
  height: 35px;
  margin: 0 5px;
  animation-delay: 0.25s;
}
.bar:nth-child(3) {
  animation-delay: 0.5s;
}
@keyframes scale-up4 {
  20% {
    background-color: #ffff;
    transform: scaleY(1.5);
  }
  40% {
    transform: scaleY(1);
  }
}

/* ===== Stop / Reverse Buttons ===== */
.stop-btn, .reverse-btn {
    padding: 6px 10px;
    border-radius: 8px;
    backdrop-filter: blur(6px);
    background: rgba(255,255,255,0.1);
    border: 1px solid #fff;
    color: #fff;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.2s ease;
}
.stop-btn:hover, .reverse-btn:hover {
    background: rgba(255,255,255,0.25);
}
body.lightmode .stop-btn, body.lightmode .reverse-btn {
    background: rgba(0,0,0,0.1);
    border: 1px solid #000;
    color: #000;
}
body.lightmode .stop-btn:hover, body.lightmode .reverse-btn:hover {
    background: rgba(0,0,0,0.25);
}
</style>
</head>

<body>
<div class="container">
    <h1>Emote Sounds</h1>

    <!-- Dark/Light Mode Toggle -->
    <label class="switch" id="darkModeSwitch">
        <input type="checkbox">
        <span class="slider"></span>
    </label>

    <!-- Dynamic List Container -->
    <div id="list"></div>

    <!-- Contact Me Button -->
    <div style="text-align:center; margin-top:40px;">
        <a href="https://twitch.tv/windowsben" target="_blank" class="contact-card">
            <img src="https://files.catbox.moe/c65dyt.png" alt="Contact Me"
                 style="width:120px; height:auto; border-radius:12px; cursor:pointer;">
        </a>
    </div>
</div>

<!-- ================== JAVASCRIPT ================== -->
<script>
// ================== CONFIG ==================
const userFiles = {
    Amedoll: "lists/Amedoll.json",
    Boshiitime: "lists/BoshiiTime.json",
    Favorite: "lists/Favorite.json",
    Fubuki_Vr: "lists/Fubuki_Vr.json",
    Greywolf: "lists/Greywolf.json",
    HeyImRadiant: "lists/HeyImRadiant.json",
    Jakkuba_VR: "lists/Jakkuba_VR.json",
    Kasimina: "lists/Kasimina.json",
    Kohrean: "lists/Kohrean.json",
    Krisuna: "lists/Krisuna.json",
    Kromia: "lists/Kromia.json",
    La_Wafflez: "lists/La_Wafflez.json",
    LittleMiri_CZ: "lists/LittleMiri_CZ.json",
    Luuna: "lists/Luuna.json",
    Puck: "lists/Puck.json",
    PuertoRicanPup: "lists/PuertoRicanPup.json",
    RadiantSoul_Tv: "lists/RadiantSoul_Tv.json",
    RadiantSoul_Tv_Sub: "lists/RadiantSoul_Tv_SubSounds.json",
    RinMunchkin: "lists/RinMunchkin.json",
    SKTKawaiiNeko: "lists/SKTKawaiiNeko.json",
    Taletrap: "lists/Taletrap.json",
    Totless: "lists/Totless.json"
};

// ================== STATE ==================
let triggerImages = {}; // emote -> image/link
let avatars = {};       // username -> avatar
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

// ================== UTILITY FUNCTIONS ==================

// Fetch + decode audio buffer
async function fetchAndDecode(url) {
    const res = await fetch(url);
    const arrayBuffer = await res.arrayBuffer();
    return await audioCtx.decodeAudioData(arrayBuffer);
}

// Stop all playing sounds globally
function stopAllSounds() {
    if (!window.__GLOBAL_SOURCES__) return;
    window.__GLOBAL_SOURCES__.forEach(src => {
        try { src.stop(); } catch(e){}
        try { src.disconnect(); } catch(e){}
    });
    window.__GLOBAL_SOURCES__ = [];
}

// Pick a weighted random sound from array [{clip, chance, volume}]
function pickWeighted(subSounds) {
    const table = [];
    subSounds.forEach(s => {
        const pct = parseFloat(s.chance);
        if (!isNaN(pct) && pct > 0) table.push({ url: s.clip, weight: pct, vol: s.volume });
    });
    if (!table.length) return { url: subSounds[0].clip, perSoundVolume: subSounds[0].volume };
    const total = table.reduce((a,b)=>a+b.weight,0);
    let roll = Math.random() * total;
    for (const row of table) {
        if ((roll -= row.weight) <= 0) return { url: row.url, perSoundVolume: row.vol };
    }
    return table[table.length-1];
}

// Create reversed audio buffer
function createReversedBuffer(srcBuffer) {
    const numChannels = srcBuffer.numberOfChannels;
    const rev = audioCtx.createBuffer(numChannels, srcBuffer.length, srcBuffer.sampleRate);
    for (let c = 0; c < numChannels; c++) {
        const ch = srcBuffer.getChannelData(c);
        const revCh = rev.getChannelData(c);
        for (let i=0, L=ch.length; i<L; i++) revCh[i] = ch[L-1-i];
    }
    return rev;
}

// ================== RESOURCE LOADING ==================
async function loadResources() {
    try {
        const resTriggers = await fetch("lists/internals/IconTriggers.json");
        triggerImages = await resTriggers.json();
        const resAvatars = await fetch("lists/internals/avatars.json");
        avatars = await resAvatars.json();
    } catch(err) {
        console.error("Failed to load resources:", err);
        document.getElementById("list").innerHTML = "<p style='color:red;'>Failed to load resources.</p>";
    }
}

// ================== DISPLAY FUNCTIONS ==================

// Show main user list
function displayUserLists() {
    const container = document.getElementById("list");
    container.innerHTML = "";

    // Search input
    const searchInput = document.createElement("input");
    searchInput.type = "text";
    searchInput.placeholder = "Search users...";
    searchInput.style = `
        margin-bottom: 15px; padding: 8px 12px; width:300px; font-size:16px;
        border-radius:12px; border:2px solid #000; background:rgba(0,0,0,0.3);
        backdrop-filter:blur(6px); color:#fff; outline:none; transition:all 0.3s;
    `;
    searchInput.addEventListener("focus", ()=>searchInput.style.borderColor="#fff");
    searchInput.addEventListener("blur", ()=>searchInput.style.borderColor="#000");
    container.appendChild(searchInput);

    // Store divs for filtering
    const userDivs = [];

    // Create user cards
    Object.keys(userFiles).forEach(user => {
        const div = document.createElement("div");
        div.className = "sound-item";
        div.style.cursor = "pointer";

        // Twitch avatar
        const img = document.createElement("img");
        img.src = avatars[user] || "https://static.twitchcdn.net/assets/favicon-32-e29e246c157142c94346.png";
        img.alt = user;

        // Link to Twitch
        const link = document.createElement("a");
        link.href = `https://twitch.tv/${user}`;
        link.target="_blank";
        link.appendChild(img);
        div.appendChild(link);

        // Text label
        const text = document.createElement("div");
        text.innerHTML = `<strong>${user}</strong><br><span>Click to view sounds</span>`;
        div.appendChild(text);

        // Click loads list
        div.addEventListener("click", e => {
            if (e.target.closest('a')) return;
            loadList(user);
        });

        container.appendChild(div);
        userDivs.push({div, name: user.toLowerCase()});
    });

    // Search filtering
    searchInput.addEventListener("input", () => {
        const query = searchInput.value.toLowerCase();
        userDivs.forEach(obj => obj.div.style.display = obj.name.includes(query) ? "flex" : "none");
    });
}

// Load and display a specific user's sounds
async function loadList(user) {
    try {
        const res = await fetch(userFiles[user]);
        const data = await res.json();
        window.location.hash = user;

        const list = Array.isArray(data) ? data : Object.values(data).find(v=>Array.isArray(v)) || [];
        displaySoundList(list, user);
    } 
        catch(err) {
        console.error("Error loading list:", err);
        const container = document.getElementById("list");
        container.innerHTML = "";

        // Create back button even when loading fails
        const backButton = document.createElement("button");
        backButton.textContent = "⬅ Back";
        backButton.style = `
            padding:8px 12px; font-size:16px; color:#fff; border-radius:8px; border:2px solid #000;
            background:rgba(0,0,0,0.3); backdrop-filter:blur(6px); cursor:pointer;
        `;
        backButton.addEventListener("click", ()=> { window.location.hash=""; displayUserLists(); });
        container.appendChild(backButton);

        // Show error message
        const errorMsg = document.createElement("p");
        errorMsg.style.color = "red";
        errorMsg.textContent = "Failed to load list.";
        container.appendChild(errorMsg);
}

}

// Render sound list for a user
function displaySoundList(list, user) {
    const container = document.getElementById("list");
    container.innerHTML = "";

    // Header: Back + Search
    const headerWrapper = document.createElement("div");
    headerWrapper.style.display = "flex"; headerWrapper.style.gap="12px"; headerWrapper.style.marginBottom="15px";

    const backButton = document.createElement("button");
    backButton.textContent = "⬅ Back";
    backButton.style = `
        padding:8px 12px; font-size:16px; color:#fff; border-radius:8px; border:2px solid #000;
        background:rgba(0,0,0,0.3); backdrop-filter:blur(6px); cursor:pointer;
    `;
    backButton.addEventListener("click", ()=> { window.location.hash=""; displayUserLists(); });
    headerWrapper.appendChild(backButton);

    const searchInput = document.createElement("input");
    searchInput.type="text"; searchInput.placeholder="Search emotes...";
    searchInput.style = `
        padding:10px; width:300px; font-size:16px; border-radius:12px; border:2px solid #000;
        background:rgba(0,0,0,0.3); backdrop-filter:blur(6px); color:#fff; outline:none; transition:all 0.3s;
    `;
    searchInput.addEventListener("focus", ()=>searchInput.style.borderColor="#fff");
    searchInput.addEventListener("blur", ()=>searchInput.style.borderColor="#000");
    headerWrapper.appendChild(searchInput);

    container.appendChild(headerWrapper);

    if (!list.length) { container.innerHTML+="<p>No sounds found.</p>"; return; }

    const emoteDivs = []; // For search filtering

    list.forEach(item => {
        if (!item.enabled || item.enabled!=="true") return;

        const div = document.createElement("div");
        div.className = "sound-item"; div.style.position="relative";

        // Custom loader wrapper
        const loader = document.createElement("div");
        loader.className = "loader";
        loader.style.display = "none";
        loader.style.position = "absolute";
        loader.style.top = "50%";
        loader.style.left = "50%";
        loader.style.transform = "translate(-50%, -50%)";
        loader.style.zIndex = "10";
        div.appendChild(loader);


        // Add bars
        ['','', ''].forEach(() => {
            const bar = document.createElement('span');
            bar.className = 'bar';
            loader.appendChild(bar);
        });


        div.style.display="flex"; div.style.alignItems="center"; div.style.gap="10px";

        // Emote image/link
        const emoteData = triggerImages[item.trigger_word];
        const emoteAnchor = document.createElement("a");
        emoteAnchor.href = emoteData?.link||"#"; emoteAnchor.target="_blank";
        const emoteImg = document.createElement("img");
        emoteImg.src = emoteData?.image || "https://files.catbox.moe/ab5icu.png";
        emoteImg.alt = item.trigger_word;
        emoteAnchor.appendChild(emoteImg); div.appendChild(emoteAnchor);

        // Text column
        const text = document.createElement("div"); text.style.flex="1";
        text.style.overflow="hidden";
        text.innerHTML = `<strong>${item.trigger_word}</strong><br><a href="${item.sound}" target="_blank">Sound Link</a>`;
        div.appendChild(text);

        // Controls container
        const controls = document.createElement("div");
        controls.style.display="flex"; controls.style.flexDirection="column"; controls.style.alignItems="flex-end"; controls.style.gap="6px"; controls.style.minWidth="120px";

        // Volume
        const volLabel = document.createElement("label"); volLabel.textContent="Vol"; volLabel.style.fontSize="12px";
        const volInput = document.createElement("input"); volInput.type="range"; volInput.min="0"; volInput.max="100";
        volInput.value = typeof item.volume==="number"?Math.round(item.volume*100):50;
        volInput.style.width="100px";
        const volWrapper = document.createElement("div"); volWrapper.style.display="flex"; volWrapper.style.flexDirection="column"; volWrapper.style.alignItems="flex-end";
        volWrapper.appendChild(volLabel); volWrapper.appendChild(volInput);

        // Pitch
        const pitchRow = document.createElement("div"); pitchRow.style.display="flex"; pitchRow.style.alignItems="center"; pitchRow.style.gap="6px";
        const pitchLabel = document.createElement("label"); pitchLabel.textContent="Speed"; pitchLabel.style.fontSize="12px";
        const pitchInput = document.createElement("input"); pitchInput.type="number"; pitchInput.min="50"; pitchInput.max="200"; pitchInput.value="100"; pitchInput.style.width="60px"; pitchInput.style.fontSize="12px";
        pitchRow.appendChild(pitchLabel); pitchRow.appendChild(pitchInput);

        // Reverse & Stop
        const reverseBtn = document.createElement("button"); reverseBtn.textContent="Reverse ▶"; reverseBtn.title="Play reversed"; reverseBtn.className="reverse-btn"; reverseBtn.style.padding="6px 8px"; reverseBtn.style.fontSize="12px"; reverseBtn.style.cursor="pointer";
        const stopBtn = document.createElement("button"); stopBtn.textContent="Stop All"; stopBtn.className="stop-btn";

        controls.appendChild(volWrapper); controls.appendChild(pitchRow); controls.appendChild(reverseBtn); controls.appendChild(stopBtn);
        div.appendChild(controls);

        // ================== AUDIO HANDLING ==================
        const bufferCache = new Map();
        const reversedCache = new Map();
        const activeSources = [];

        async function getBufferForUrl(url) {
            if (bufferCache.has(url)) return bufferCache.get(url);
            loader.style.display="flex";
            try {
                const decoded = await fetchAndDecode(url);
                bufferCache.set(url, decoded);
                loader.style.display="none";
                return decoded;
            } catch(err) { loader.style.display="none"; throw err; }
        }

        async function playRandomBuffer({reversed=false}={}) {
            try {
                let chosenUrl=null; let perSoundVolume=null;
                if (Array.isArray(item.sound)) {
                    if (item.sound.length>0 && typeof item.sound[0]==="object") {
                        const picked=pickWeighted(item.sound);
                        chosenUrl=picked.url; perSoundVolume=picked.perSoundVolume;
                    } else { chosenUrl=item.sound[Math.floor(Math.random()*item.sound.length)]; }
                } else { chosenUrl=item.sound; }

                const buf = await getBufferForUrl(chosenUrl);
                const bufferToPlay = reversed ? (reversedCache.has(chosenUrl)?reversedCache.get(chosenUrl):reversedCache.set(chosenUrl,createReversedBuffer(buf)).get(chosenUrl)) : buf;

                const src = audioCtx.createBufferSource(); src.buffer=bufferToPlay;

                activeSources.push(src);
                if (!window.__GLOBAL_SOURCES__) window.__GLOBAL_SOURCES__=[];
                window.__GLOBAL_SOURCES__.push(src);

                const gainNode = audioCtx.createGain();
                const finalGain = ((parseFloat(volInput.value)||50)/100)*(perSoundVolume!=null?perSoundVolume:1);
                gainNode.gain.value = finalGain;

                src.playbackRate.value = Math.max(0.01,(parseFloat(pitchInput.value)||100)/100);

                src.connect(gainNode).connect(audioCtx.destination);
                src.start(0);

                src.onended = ()=>{ try{ src.disconnect(); gainNode.disconnect(); }catch(e){}; activeSources.splice(activeSources.indexOf(src),1); };
                return src;
            } catch(err){ console.error("Playback error:", err); throw err; }
        }

        // Container click plays forward sound
        div.addEventListener("click", e=>{ if(e.target.closest('a')) return; playRandomBuffer({reversed:false}).catch(err=>console.error(err)); });
        reverseBtn.addEventListener("click", e=>{ e.stopPropagation(); playRandomBuffer({reversed:true}).catch(err=>console.error(err)); });
        stopBtn.addEventListener("click", e=>{ e.stopPropagation(); stopAllSounds(); });

        // Volume live update
        volInput.addEventListener("input", ()=>{}); // affects next play

        // Pitch Enter key handling
        pitchInput.addEventListener("keydown", ev=>{ if(ev.key==="Enter") ev.target.blur(); });

        container.appendChild(div);
        emoteDivs.push({div, trigger_word:item.trigger_word.toLowerCase()});
    });

    // Search filtering
    searchInput.addEventListener("input", ()=>{
        const query=searchInput.value.toLowerCase();
        emoteDivs.forEach(obj=>obj.div.style.display=obj.trigger_word.includes(query)?"flex":"none");
    });
}

// ================== HASH NAVIGATION ==================
window.addEventListener('hashchange', ()=>{
    const hashUser = window.location.hash.slice(1);
    if(hashUser && userFiles[hashUser]) loadList(hashUser);
    else displayUserLists();
});

// ================== DARK/LIGHT MODE TOGGLE ==================
const darkModeSwitch = document.getElementById("darkModeSwitch").querySelector("input");
darkModeSwitch.checked = document.body.classList.contains("lightmode");
darkModeSwitch.addEventListener("change", ()=>{ document.body.classList.toggle("lightmode", darkModeSwitch.checked); });

// ================== INIT ==================
window.addEventListener("DOMContentLoaded", async ()=>{
    await loadResources();
    const hashUser = window.location.hash.slice(1);
    if(hashUser && userFiles[hashUser]) loadList(hashUser);
    else displayUserLists();
});
</script>

</body>
</html>
